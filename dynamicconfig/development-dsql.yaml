# Dynamic configuration for Aurora DSQL production benchmarking
# Infrastructure: 6 Ã— m7g.xlarge EC2, 4096 shards, 3-node OpenSearch

# =============================================================================
# Eager Execution Settings
# =============================================================================

# Enable eager activity execution - activities can be dispatched back to the
# same worker that completed the workflow task, bypassing the server round-trip
# Required for SDK's DisableEagerActivities=false to have effect
# Default: false (must be explicitly enabled)
system.enableActivityEagerExecution:
  - value: true
    constraints: {}

# Eager workflow start is enabled by default (true)
# Allows first workflow task to be returned inline with StartWorkflowExecution response
# system.enableEagerWorkflowStart:
#   - value: true
#     constraints: {}

# =============================================================================
# DSQL-Specific Settings
# =============================================================================

# Enable DSQL mode for optimistic concurrency control handling
persistence.enableDSQLMode:
  - value: true
    constraints: {}

# DSQL optimizations - higher QPS for production workloads
# With 4 history replicas and 4096 shards, we need higher throughput
history.persistenceMaxQPS:
  - value: 9000
    constraints: {}

matching.persistenceMaxQPS:
  - value: 9000
    constraints: {}

frontend.persistenceMaxQPS:
  - value: 9000
    constraints: {}

# DSQL transaction size limit (4MB)
# Note: Connection pool settings (maxConns, maxIdleConns) are configured via
# static config (persistence-dsql.template.yaml) using TEMPORAL_SQL_MAX_CONNS
# and TEMPORAL_SQL_MAX_IDLE_CONNS environment variables, not dynamic config.
persistence.transactionSizeLimit:
  - value: 4000000
    constraints: {}

# DSQL connection health check
persistence.healthCheckInterval:
  - value: 30s
    constraints: {}

# =============================================================================
# Advanced Visibility (OpenSearch) Settings
# =============================================================================

system.advancedVisibilityWritingMode:
  - value: "on"
    constraints: {}

system.enableReadFromClosedExecutionV2:
  - value: true
    constraints: {}

system.enableReadVisibilityFromES:
  - value: true
    constraints: {}

# OpenSearch bulk processor settings for high throughput
# 3-node m6g.large cluster can handle higher batch sizes
visibility.maxPageSize:
  - value: 1000
    constraints: {}

# Force refresh search attributes cache on read
system.forceSearchAttributesCacheRefreshOnRead:
  - value: true
    constraints: {}

system.enableLogCustomerQueryParameter:
  - value: true
    constraints: {}

# =============================================================================
# History Service Settings
# =============================================================================

# Higher buffer for 4096 shards
history.maxBufferedQueryCount:
  - value: 2000
    constraints: {}

# Timer processor settings - increased for production
history.timerProcessorMaxPollRPS:
  - value: 100
    constraints: {}

history.timerProcessorUpdateAckInterval:
  - value: 10s
    constraints: {}

# Transfer processor settings
history.transferProcessorMaxPollRPS:
  - value: 100
    constraints: {}

# Replication settings
history.replicationTaskProcessorMaxPollRPS:
  - value: 100
    constraints: {}

# =============================================================================
# History Cache Settings (CRITICAL for performance)
# =============================================================================

# Use size-based cache limiting instead of entry count
# This allows more efficient memory utilization for varying workflow sizes
history.cacheSizeBasedLimit:
  - value: true
    constraints: {}

# Max cache size per history host: 1GB
# With 8 history replicas = 8GB total cache capacity
# This is critical for reducing GetWorkflowExecution calls
history.hostLevelCacheMaxSizeBytes:
  - value: 1073741824
    constraints: {}

# Cache TTL: 1 hour (default)
history.cacheTTL:
  - value: 1h
    constraints: {}

# Non-user context lock timeout
history.cacheNonUserContextLockTimeout:
  - value: 500ms
    constraints: {}

history.historyShardControllerMaxConcurrentAcquires:
  - value: 10
    constraints: {}

# Default activity retry policy
history.defaultActivityRetryPolicy:
  - value:
      InitialIntervalInSeconds: 1
      MaximumIntervalInSeconds: 100
      BackoffCoefficient: 2.0
      MaximumAttempts: 0
    constraints: {}

# =============================================================================
# Matching Service Settings
# =============================================================================

# Task queue partitions - increased for 150 WPS throughput
# More partitions = better parallelism for high-volume task queues
matching.numTaskqueueWritePartitions:
  - value: 32
    constraints: {}

matching.numTaskqueueReadPartitions:
  - value: 32
    constraints: {}

# Matching service throughput settings - tuned for 150 WPS
matching.maxTaskBatchSize:
  - value: 100
    constraints: {}

matching.getTasksBatchSize:
  - value: 500
    constraints: {}

matching.longPollExpirationInterval:
  - value: 60s
    constraints: {}

# Forwarder settings for multi-partition task queues - tuned for 150 WPS
matching.forwarderMaxOutstandingPolls:
  - value: 40
    constraints: {}

matching.forwarderMaxOutstandingTasks:
  - value: 400
    constraints: {}

matching.forwarderMaxRatePerSecond:
  - value: 400
    constraints: {}

matching.enableTaskInfoLogByDomainID:
  - value: false
    constraints: {}

# =============================================================================
# Frontend Service Settings
# =============================================================================

frontend.enableClientVersionCheck:
  - value: true
    constraints: {}

# Rate limiting - tuned for 400 WPS
frontend.rps:
  - value: 15000
    constraints: {}

frontend.namespaceRPS:
  - value: 15000
    constraints: {}

frontend.namespaceCount:
  - value: 4000
    constraints: {}

# Visibility rate limits
frontend.visibilityMaxPageSize:
  - value: 1000
    constraints: {}

# =============================================================================
# Worker Service Settings
# =============================================================================

worker.enableBatcher:
  - value: true
    constraints: {}

worker.enableLogging:
  - value: true
    constraints: {}

# Scanner settings
worker.scannerMaxConcurrentActivityExecutionSize:
  - value: 10
    constraints: {}

worker.scannerMaxConcurrentWorkflowTaskExecutionSize:
  - value: 10
    constraints: {}

# =============================================================================
# Cluster Membership Settings
# =============================================================================

# Increased for ECS startup with multiple replicas
system.membershipMaxJoinDuration:
  - value: 120s
    constraints: {}

# =============================================================================
# System Settings
# =============================================================================

system.enableParentClosePolicy:
  - value: true
    constraints: {}

system.enableNamespaceNotActiveAutoForwarding:
  - value: true
    constraints: {}

# Rate limiting for logs
system.enableLoggerRateLimiting:
  - value: true
    constraints: {}

# =============================================================================
# Archival Settings
# =============================================================================

archival.history.enableRead:
  - value: true
    constraints: {}

archival.visibility.enableRead:
  - value: true
    constraints: {}

# =============================================================================
# Nexus Settings - DISABLED for DSQL compatibility
# =============================================================================

system.enableNexus:
  - value: false
    constraints: {}

frontend.enableNexusAPIs:
  - value: false
    constraints: {}

worker.enableNexus:
  - value: false
    constraints: {}

system.nexusEndpointRegistryEnabled:
  - value: false
    constraints: {}
