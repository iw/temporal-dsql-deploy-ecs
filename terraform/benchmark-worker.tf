# -----------------------------------------------------------------------------
# Benchmark Worker Service
# -----------------------------------------------------------------------------
# This file creates a dedicated ECS service for benchmark workers.
# The workers process benchmark workflows generated by the benchmark generator task.
#
# Key features:
# - Runs in worker-only mode (BENCHMARK_WORKER_ONLY=true)
# - Scalable independently from the generator
# - Uses the same benchmark image but different configuration
# - Long-running service (not a one-shot task)
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Benchmark Worker Task Definition
# -----------------------------------------------------------------------------

resource "aws_ecs_task_definition" "benchmark_worker" {
  family                   = "${var.project_name}-benchmark-worker"
  requires_compatibilities = ["EC2"]
  network_mode             = "awsvpc"
  cpu                      = var.benchmark_worker_cpu
  memory                   = var.benchmark_worker_memory
  execution_role_arn       = aws_iam_role.ecs_execution.arn
  task_role_arn            = aws_iam_role.benchmark_task.arn

  runtime_platform {
    operating_system_family = "LINUX"
    cpu_architecture        = "ARM64"
  }

  container_definitions = jsonencode([
    {
      name      = "benchmark-worker"
      image     = var.benchmark_image != "" ? var.benchmark_image : "public.ecr.aws/amazonlinux/amazonlinux:2023-minimal"
      essential = true

      portMappings = [
        {
          containerPort = 9090
          protocol      = "tcp"
          name          = "metrics"
        }
      ]

      environment = [
        { name = "TEMPORAL_ADDRESS", value = "temporal-frontend:7233" },
        { name = "BENCHMARK_NAMESPACE", value = "benchmark" },
        { name = "BENCHMARK_WORKER_ONLY", value = "true" },
        # These are not used in worker-only mode but required for config validation
        { name = "BENCHMARK_WORKFLOW_TYPE", value = "simple" },
        { name = "BENCHMARK_TARGET_RATE", value = "100" },
        { name = "BENCHMARK_DURATION", value = "5m" }
      ]

      logConfiguration = {
        logDriver = "awslogs"
        options = {
          "awslogs-group"         = aws_cloudwatch_log_group.benchmark_worker.name
          "awslogs-region"        = var.region
          "awslogs-stream-prefix" = "benchmark-worker"
          "awslogs-create-group"  = "true"
        }
      }

      linuxParameters = {
        initProcessEnabled = true
      }
    }
  ])

  tags = {
    Name    = "${var.project_name}-benchmark-worker"
    Service = "benchmark-worker"
  }
}

# -----------------------------------------------------------------------------
# Benchmark Worker CloudWatch Log Group
# -----------------------------------------------------------------------------

resource "aws_cloudwatch_log_group" "benchmark_worker" {
  name              = "/ecs/${var.project_name}/benchmark-worker"
  retention_in_days = var.log_retention_days

  tags = {
    Name = "${var.project_name}-benchmark-worker-logs"
  }
}

# -----------------------------------------------------------------------------
# Benchmark Worker ECS Service
# -----------------------------------------------------------------------------

resource "aws_ecs_service" "benchmark_worker" {
  name            = "${var.project_name}-benchmark-worker"
  cluster         = aws_ecs_cluster.main.id
  task_definition = aws_ecs_task_definition.benchmark_worker.arn
  desired_count   = var.benchmark_worker_count

  # Use EC2 capacity provider
  capacity_provider_strategy {
    capacity_provider = aws_ecs_capacity_provider.ec2.name
    weight            = 1
    base              = 0
  }

  enable_execute_command = true

  network_configuration {
    subnets          = aws_subnet.private[*].id
    security_groups  = [aws_security_group.ecs_instances.id, aws_security_group.benchmark.id]
    assign_public_ip = false
  }

  # Service Connect for accessing Temporal Frontend
  service_connect_configuration {
    enabled   = true
    namespace = aws_service_discovery_http_namespace.main.arn

    # Client-only mode - consumes services but doesn't expose any
  }

  deployment_maximum_percent         = 200
  deployment_minimum_healthy_percent = 100

  tags = {
    Name    = "${var.project_name}-benchmark-worker"
    Service = "benchmark-worker"
  }

  lifecycle {
    ignore_changes = [desired_count]
  }
}

# -----------------------------------------------------------------------------
# Benchmark Worker Variables
# -----------------------------------------------------------------------------

variable "benchmark_worker_cpu" {
  description = "CPU units for benchmark worker task"
  type        = number
  default     = 2048

  validation {
    condition     = contains([256, 512, 1024, 2048, 4096], var.benchmark_worker_cpu)
    error_message = "CPU must be a valid ECS CPU value."
  }
}

variable "benchmark_worker_memory" {
  description = "Memory in MB for benchmark worker task"
  type        = number
  default     = 4096

  validation {
    condition     = var.benchmark_worker_memory >= 512 && var.benchmark_worker_memory <= 30720
    error_message = "Memory must be between 512 MB and 30720 MB."
  }
}

variable "benchmark_worker_count" {
  description = "Number of benchmark worker tasks to run (0 to disable)"
  type        = number
  default     = 0

  validation {
    condition     = var.benchmark_worker_count >= 0 && var.benchmark_worker_count <= 10
    error_message = "Worker count must be between 0 and 10."
  }
}

# -----------------------------------------------------------------------------
# Benchmark Worker Outputs
# -----------------------------------------------------------------------------

output "benchmark_worker_service_name" {
  description = "Name of the Benchmark Worker ECS service"
  value       = aws_ecs_service.benchmark_worker.name
}

output "benchmark_worker_task_definition_arn" {
  description = "ARN of the Benchmark Worker task definition"
  value       = aws_ecs_task_definition.benchmark_worker.arn
}

output "benchmark_worker_log_group_name" {
  description = "Name of the Benchmark Worker CloudWatch Log Group"
  value       = aws_cloudwatch_log_group.benchmark_worker.name
}
