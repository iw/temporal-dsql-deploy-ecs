# -----------------------------------------------------------------------------
# ADOT Sidecar Configuration for Temporal Services
# -----------------------------------------------------------------------------
# This configuration is used by ADOT sidecars running alongside each Temporal
# service container. Each sidecar scrapes localhost:9090 and pushes to AMP.
#
# Uses ECS resource detection to add unique task_id label per replica.
# -----------------------------------------------------------------------------

receivers:
  prometheus:
    config:
      scrape_configs:
        - job_name: '${service_name}'
          scrape_interval: 15s
          scrape_timeout: 10s
          static_configs:
            - targets: ['localhost:9090']
          metric_relabel_configs:
            # Add service_name label
            - source_labels: []
              target_label: service_name
              replacement: '${service_name}'

processors:
  # Add ECS task metadata as resource attributes
  resourcedetection/ecs:
    detectors: [env, ecs]
    timeout: 5s
    override: false

  # Convert resource attributes to metric attributes
  resource:
    attributes:
      - key: task_id
        from_attribute: aws.ecs.task.id
        action: insert
      - key: cluster
        from_attribute: aws.ecs.cluster.name
        action: insert

exporters:
  prometheusremotewrite:
    endpoint: "${amp_remote_write_endpoint}"
    auth:
      authenticator: sigv4auth
    resource_to_telemetry_conversion:
      enabled: true

extensions:
  sigv4auth:
    region: "${aws_region}"
    service: "aps"

service:
  extensions: [sigv4auth]
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [resourcedetection/ecs, resource]
      exporters: [prometheusremotewrite]
