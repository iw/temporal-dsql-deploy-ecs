# -----------------------------------------------------------------------------
# Benchmark Worker Service
# -----------------------------------------------------------------------------
# This file creates a dedicated ECS service for benchmark workers.
# The workers process benchmark workflows generated by the benchmark generator task.
#
# Key features:
# - Runs in worker-only mode (BENCHMARK_WORKER_ONLY=true)
# - Scalable independently from the generator
# - Uses the same benchmark image but different configuration
# - Long-running service (not a one-shot task)
# - Alloy sidecar for log collection to Loki
#
# Requirements: 10.1
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Benchmark Worker Task Definition
# -----------------------------------------------------------------------------

resource "aws_ecs_task_definition" "benchmark_worker" {
  family                   = "${var.project_name}-benchmark-worker"
  requires_compatibilities = ["EC2"]
  network_mode             = "awsvpc"
  cpu                      = var.worker_cpu
  memory                   = var.worker_memory
  execution_role_arn       = var.execution_role_arn
  task_role_arn            = aws_iam_role.benchmark_task.arn

  runtime_platform {
    operating_system_family = "LINUX"
    cpu_architecture        = "ARM64"
  }

  # Docker socket volume for Alloy log collection
  volume {
    name      = "docker-socket"
    host_path = "/var/run/docker.sock"
  }

  # Alloy config volume (populated by init container)
  volume {
    name = "alloy-config"
  }

  container_definitions = jsonencode([
    {
      name      = "benchmark-worker"
      image     = var.benchmark_image != "" ? var.benchmark_image : "public.ecr.aws/amazonlinux/amazonlinux:2023-minimal"
      essential = true
      # Reserve CPU/memory for Alloy sidecar (init: 64 CPU, 128 MB + sidecar: 128 CPU, 256 MB = 192 CPU, 384 MB)
      cpu    = var.worker_cpu - 192
      memory = var.worker_memory - 384

      portMappings = [
        {
          containerPort = 9090
          protocol      = "tcp"
          name          = "metrics"
        }
      ]

      environment = [
        { name = "TEMPORAL_ADDRESS", value = "temporal-frontend:7233" },
        { name = "BENCHMARK_NAMESPACE", value = "benchmark" },
        { name = "BENCHMARK_WORKER_ONLY", value = "true" },
        # These are not used in worker-only mode but required for config validation
        { name = "BENCHMARK_WORKFLOW_TYPE", value = "simple" },
        { name = "BENCHMARK_TARGET_RATE", value = "100" },
        { name = "BENCHMARK_DURATION", value = "5m" }
      ]

      # No log configuration - logs collected by Alloy sidecar

      linuxParameters = {
        initProcessEnabled = true
      }
    },
    var.alloy_worker_init_container,
    var.alloy_worker_sidecar_container
  ])

  tags = {
    Name    = "${var.project_name}-benchmark-worker"
    Service = "benchmark-worker"
  }
}

# -----------------------------------------------------------------------------
# Benchmark Worker ECS Service
# -----------------------------------------------------------------------------

resource "aws_ecs_service" "benchmark_worker" {
  name            = "${var.project_name}-benchmark-worker"
  cluster         = var.cluster_id
  task_definition = aws_ecs_task_definition.benchmark_worker.arn
  desired_count   = var.worker_count

  # Use dedicated benchmark capacity provider (scale-from-zero)
  capacity_provider_strategy {
    capacity_provider = aws_ecs_capacity_provider.benchmark.name
    weight            = 1
    base              = 0
  }

  # Force new deployment when changing capacity provider
  force_new_deployment = true

  enable_execute_command = true

  network_configuration {
    subnets          = var.subnet_ids
    security_groups  = [var.instance_security_group_id, aws_security_group.benchmark.id]
    assign_public_ip = false
  }

  # Service Connect for accessing Temporal Frontend
  # Note: Metrics are collected by Alloy sidecar, not via Service Connect
  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    # Client-only mode - consumes services but doesn't expose any
  }

  deployment_maximum_percent         = 200
  deployment_minimum_healthy_percent = 100

  tags = {
    Name    = "${var.project_name}-benchmark-worker"
    Service = "benchmark-worker"
  }

  lifecycle {
    ignore_changes = [desired_count]
  }
}

