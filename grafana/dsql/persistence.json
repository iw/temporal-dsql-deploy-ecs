{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": { "type": "grafana", "uid": "-- Grafana --" },
        "enable": true,
        "hide": false,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "Aurora DSQL persistence metrics for Temporal. Monitors connection pool health, persistence latency, and transaction conflicts.",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "iteration": 1,
  "links": [
    {
      "asDropdown": false,
      "icon": "external link",
      "includeVars": true,
      "keepTime": true,
      "tags": ["temporal"],
      "targetBlank": true,
      "title": "Temporal Server Dashboard",
      "type": "dashboards"
    }
  ],
  "liveNow": false,
  "panels": [
    {
      "id": 1,
      "type": "text",
      "title": "DSQL Persistence Overview",
      "gridPos": { "h": 5, "w": 24, "x": 0, "y": 0 },
      "options": {
        "mode": "markdown",
        "content": "## Aurora DSQL Persistence Dashboard\n\nThis dashboard monitors Aurora DSQL as Temporal's persistence layer:\n\n- **Connection Pool**: Always available - shows pool utilization and health\n- **Persistence Latency**: Database operation latency from Temporal's persistence layer\n- **Transaction Conflicts**: Populated when OCC conflicts occur under contention (zero = healthy)\n- **CloudWatch Metrics**: AWS-side metrics (requires cluster ID and IAM permissions)\n\n**Troubleshooting**: Start with Connection Pool → Persistence Latency → Transaction Conflicts → CloudWatch"
      }
    },

    { "id": 2, "type": "row", "title": "Connection Pool Health", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 }, "collapsed": false, "panels": [] },

    {
      "id": 3,
      "type": "stat",
      "title": "Pool Utilization",
      "description": "Percentage of max connections in use. Above 80% is a warning sign.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 6 },
      "fieldConfig": { "defaults": { "unit": "percentunit", "min": 0, "max": 1, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 0.7 }, { "color": "red", "value": 0.9 }] } }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_pool_in_use) / sum(dsql_pool_max_open)", "legendFormat": "utilization" }]
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Connections In Use",
      "description": "Active connections currently executing queries.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 6 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] } }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_pool_in_use)", "legendFormat": "in_use" }]
    },
    {
      "id": 5,
      "type": "stat",
      "title": "Idle Connections",
      "description": "Available connections ready for use. Zero with high utilization = pool exhaustion.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 6 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 2 }, { "color": "green", "value": 5 }] } }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_pool_idle)", "legendFormat": "idle" }]
    },
    {
      "id": 6,
      "type": "stat",
      "title": "Max Connections",
      "description": "Configured maximum pool size.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 6 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] } }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_pool_max_open)", "legendFormat": "max_open" }]
    },

    {
      "id": 7,
      "type": "timeseries",
      "title": "Connection Pool Over Time",
      "description": "Connection pool state over time. Watch for in_use approaching max_open.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 10 },
      "fieldConfig": { "defaults": { "unit": "short", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
      "targets": [
        { "refId": "A", "expr": "sum(dsql_pool_max_open)", "legendFormat": "max_open" },
        { "refId": "B", "expr": "sum(dsql_pool_open)", "legendFormat": "open" },
        { "refId": "C", "expr": "sum(dsql_pool_in_use)", "legendFormat": "in_use" },
        { "refId": "D", "expr": "sum(dsql_pool_idle)", "legendFormat": "idle" }
      ]
    },
    {
      "id": 8,
      "type": "timeseries",
      "title": "Connection Wait Time",
      "description": "Time spent waiting for connections. Sustained waits indicate pool exhaustion.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 10 },
      "fieldConfig": { "defaults": { "unit": "short", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
      "targets": [
        { "refId": "A", "expr": "sum(rate(dsql_pool_wait_total[1m]))", "legendFormat": "waits/sec" },
        { "refId": "B", "expr": "histogram_quantile(0.95, sum by (le) (rate(dsql_pool_wait_duration_bucket[5m])))", "legendFormat": "wait p95" }
      ]
    },
    {
      "id": 27,
      "type": "timeseries",
      "title": "Connection Closures by Reason",
      "description": "Why connections are being closed. MaxLifetime = expected (55min rotation). MaxIdleTime/MaxIdle = should be 0 if pool configured correctly. If these increase but pool metrics don't show it, connections are being closed by server/network.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 18 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "showPoints": "never", "lineWidth": 2 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "MaxLifetime" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "MaxIdleTime" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "MaxIdle" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] }
        ]
      },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
      "targets": [
        { "refId": "A", "expr": "sum(dsql_db_closed_max_lifetime_total)", "legendFormat": "MaxLifetime" },
        { "refId": "B", "expr": "sum(dsql_db_closed_max_idle_time_total)", "legendFormat": "MaxIdleTime" },
        { "refId": "C", "expr": "sum(dsql_db_closed_max_idle_total)", "legendFormat": "MaxIdle" }
      ]
    },

    { "id": 9, "type": "row", "title": "Persistence Latency", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 26 }, "collapsed": false, "panels": [] },

    {
      "id": 10,
      "type": "timeseries",
      "title": "Persistence Latency by Operation",
      "description": "Database operation latency (p95). Rising latency cascades into workflow delays.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 27 },
      "fieldConfig": { "defaults": { "unit": "s", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max"] } },
      "targets": [{ "refId": "A", "expr": "topk(8, histogram_quantile(0.95, sum by (operation, le) (rate(persistence_latency_bucket[5m]))))", "legendFormat": "{{operation}}" }]
    },
    {
      "id": 11,
      "type": "timeseries",
      "title": "Persistence Request Rate",
      "description": "Database operations per second by type.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 27 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean"] } },
      "targets": [{ "refId": "A", "expr": "topk(8, sum by (operation) (rate(persistence_requests_total[1m])))", "legendFormat": "{{operation}}" }]
    },

    {
      "id": 12,
      "type": "timeseries",
      "title": "Persistence Errors",
      "description": "Database errors by type. Some errors trigger automatic retries.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 6, "w": 24, "x": 0, "y": 35 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["sum"] } },
      "targets": [
        { "refId": "A", "expr": "sum by (operation) (rate(persistence_errors_total[1m]))", "legendFormat": "{{operation}}" },
        { "refId": "B", "expr": "sum by (error_type) (rate(persistence_error_with_type_total[1m]))", "legendFormat": "type: {{error_type}}" }
      ]
    },

    { "id": 13, "type": "row", "title": "Transaction Conflicts (OCC)", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 41 }, "collapsed": false, "panels": [] },

    {
      "id": 14,
      "type": "text",
      "title": "About Transaction Conflicts",
      "gridPos": { "h": 3, "w": 24, "x": 0, "y": 42 },
      "options": {
        "mode": "markdown",
        "content": "**Note**: These metrics only populate when transaction conflicts occur. Zero values indicate healthy operation with no contention. DSQL uses optimistic concurrency control (OCC) - conflicts are expected under high concurrent load and are automatically retried. Watch for **exhausted** (retries failed) which indicates severe contention."
      }
    },

    {
      "id": 15,
      "type": "stat",
      "title": "Conflict Rate",
      "description": "Transaction conflicts per second (SQLSTATE 40001). Some conflicts are normal under load.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 45 },
      "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 50 }] }, "noValue": "0" }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(rate(dsql_tx_conflict_total[1m])) or vector(0)", "legendFormat": "conflicts/sec" }]
    },
    {
      "id": 16,
      "type": "stat",
      "title": "Retry Rate",
      "description": "Automatic retries per second. Retries are expected and handled transparently.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 45 },
      "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 20 }, { "color": "red", "value": 100 }] }, "noValue": "0" }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(rate(dsql_tx_retry_total[1m])) or vector(0)", "legendFormat": "retries/sec" }]
    },
    {
      "id": 17,
      "type": "stat",
      "title": "Exhausted (Failures)",
      "description": "Transactions that failed after max retries. Should be zero. Non-zero = severe contention.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 45 },
      "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 0.1 }] }, "noValue": "0" }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(rate(dsql_tx_exhausted_total[1m])) or vector(0)", "legendFormat": "exhausted/sec" }]
    },
    {
      "id": 18,
      "type": "stat",
      "title": "Tx Latency p95",
      "description": "95th percentile transaction latency including retries.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 45 },
      "fieldConfig": { "defaults": { "unit": "s", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 0.1 }, { "color": "red", "value": 0.5 }] }, "noValue": "N/A" }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none" },
      "targets": [{ "refId": "A", "expr": "histogram_quantile(0.95, sum by (le) (rate(dsql_tx_latency_bucket[5m])))", "legendFormat": "p95" }]
    },

    {
      "id": 19,
      "type": "timeseries",
      "title": "Conflicts & Retries Over Time",
      "description": "Transaction conflicts and retries. Populated only when contention occurs.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 49 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
      "targets": [
        { "refId": "A", "expr": "sum(rate(dsql_tx_conflict_total[1m]))", "legendFormat": "conflicts/sec" },
        { "refId": "B", "expr": "sum(rate(dsql_tx_retry_total[1m]))", "legendFormat": "retries/sec" },
        { "refId": "C", "expr": "sum(rate(dsql_tx_exhausted_total[1m]))", "legendFormat": "exhausted/sec" }
      ]
    },
    {
      "id": 20,
      "type": "timeseries",
      "title": "Errors by Class",
      "description": "DSQL errors by classification. serialization_failure triggers retries.",
      "datasource": { "type": "prometheus", "uid": "amp" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 49 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["sum"] } },
      "targets": [{ "refId": "A", "expr": "sum by (error_class) (rate(dsql_tx_error_class_total[1m]))", "legendFormat": "{{error_class}}" }]
    },

    { "id": 21, "type": "row", "title": "CloudWatch Metrics (AWS)", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 57 }, "collapsed": true, "panels": [
      {
        "id": 22,
        "type": "text",
        "title": "CloudWatch Setup",
        "gridPos": { "h": 3, "w": 24, "x": 0, "y": 58 },
        "options": {
          "mode": "markdown",
          "content": "**Setup Required**: Enter your DSQL cluster ID in the dashboard variable above. Ensure Grafana has CloudWatch IAM permissions (`cloudwatch:GetMetricData`). CloudWatch queries incur costs (~$5-15/month for a single cluster)."
        }
      },
      {
        "id": 23,
        "type": "timeseries",
        "title": "DSQL Throughput",
        "datasource": { "type": "cloudwatch", "uid": "cloudwatch" },
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 53 },
        "fieldConfig": { "defaults": { "unit": "bytes", "custom": { "showPoints": "never" } }, "overrides": [] },
        "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
        "targets": [
          { "refId": "A", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "BytesRead", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "bytes read" },
          { "refId": "B", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "BytesWritten", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "bytes written" }
        ]
      },
      {
        "id": 24,
        "type": "timeseries",
        "title": "DSQL Commit Latency",
        "datasource": { "type": "cloudwatch", "uid": "cloudwatch" },
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 53 },
        "fieldConfig": { "defaults": { "unit": "ms", "custom": { "showPoints": "never" } }, "overrides": [] },
        "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
        "targets": [
          { "refId": "A", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "CommitLatency", "statistic": "Average", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "commit latency (avg)" },
          { "refId": "B", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "TotalTransactions", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "transactions" }
        ]
      },
      {
        "id": 25,
        "type": "timeseries",
        "title": "DSQL DPU Usage",
        "datasource": { "type": "cloudwatch", "uid": "cloudwatch" },
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 61 },
        "fieldConfig": { "defaults": { "unit": "short", "custom": { "showPoints": "never" } }, "overrides": [] },
        "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
        "targets": [
          { "refId": "A", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "TotalDPU", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "total DPU" },
          { "refId": "B", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "ReadDPU", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "read DPU" },
          { "refId": "C", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "WriteDPU", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "write DPU" }
        ]
      },
      {
        "id": 26,
        "type": "timeseries",
        "title": "DSQL OCC Conflicts",
        "datasource": { "type": "cloudwatch", "uid": "cloudwatch" },
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 61 },
        "fieldConfig": { "defaults": { "unit": "short", "custom": { "showPoints": "never" } }, "overrides": [] },
        "options": { "legend": { "displayMode": "list", "placement": "bottom" } },
        "targets": [
          { "refId": "A", "datasource": { "type": "cloudwatch", "uid": "cloudwatch" }, "queryMode": "Metrics", "metricQueryType": 0, "metricEditorMode": 0, "namespace": "AWS/AuroraDSQL", "metricName": "OccConflicts", "statistic": "Sum", "dimensions": { "ClusterId": "${dsql_cluster:raw}" }, "matchExact": true, "period": "", "region": "default", "label": "OCC conflicts" }
        ]
      }
    ]}
  ],

  "refresh": "30s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["temporal", "dsql", "persistence", "aurora"],
  "templating": {
    "list": [
      {
        "name": "dsql_cluster",
        "label": "DSQL Cluster ID",
        "type": "textbox",
        "description": "Aurora DSQL cluster identifier for CloudWatch metrics (optional)",
        "query": "",
        "current": { "text": "", "value": "" }
      }
    ]
  },
  "time": { "from": "now-30m", "to": "now" },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m"],
    "time_options": ["5m", "15m", "30m", "1h", "6h"]
  },
  "timezone": "browser",
  "title": "DSQL Persistence",
  "uid": "dsql-persistence",
  "version": 1,
  "weekStart": ""
}
