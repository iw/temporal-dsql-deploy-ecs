# Temporal Persistence Configuration for DSQL + OpenSearch (AWS)
# This template is rendered at container startup using environment variables
#
# Required environment variables:
# - TEMPORAL_SQL_HOST, TEMPORAL_SQL_PORT, TEMPORAL_SQL_DATABASE, TEMPORAL_SQL_USER
# - TEMPORAL_SQL_PLUGIN_NAME, TEMPORAL_SQL_TLS_ENABLED
# - TEMPORAL_SQL_MAX_CONNS, TEMPORAL_SQL_MAX_IDLE_CONNS
# - TEMPORAL_SQL_CONNECTION_TIMEOUT, TEMPORAL_SQL_MAX_CONN_LIFETIME
# - TEMPORAL_HISTORY_SHARDS
# - TEMPORAL_ELASTICSEARCH_HOST, TEMPORAL_ELASTICSEARCH_INDEX
# - AWS_REGION (for OpenSearch SigV4 signing)

persistence:
  defaultStore: dsql-default
  visibilityStore: es-visibility
  advancedVisibilityStore: es-visibility
  numHistoryShards: $TEMPORAL_HISTORY_SHARDS
  datastores:
    dsql-default:
      sql:
        pluginName: $TEMPORAL_SQL_PLUGIN_NAME
        databaseName: $TEMPORAL_SQL_DATABASE
        connectAddr: $TEMPORAL_SQL_HOST:$TEMPORAL_SQL_PORT
        connectProtocol: tcp
        user: $TEMPORAL_SQL_USER
        maxConns: $TEMPORAL_SQL_MAX_CONNS
        maxIdleConns: $TEMPORAL_SQL_MAX_IDLE_CONNS
        # Optimized for DSQL's serverless architecture
        connectionTimeout: $TEMPORAL_SQL_CONNECTION_TIMEOUT
        maxConnLifetime: $TEMPORAL_SQL_MAX_CONN_LIFETIME
        tls:
          enabled: $TEMPORAL_SQL_TLS_ENABLED
    es-visibility:
      elasticsearch:
        version: $TEMPORAL_ELASTICSEARCH_VERSION
        url:
          scheme: "https"
          host: "$TEMPORAL_ELASTICSEARCH_HOST"
          port: 443
        # AWS OpenSearch with IAM authentication (SigV4)
        # Note: field name must be "aws-request-signing" (with hyphens) to match Go struct yaml tag
        aws-request-signing:
          enabled: true
          region: "$AWS_REGION"
          # Use aws-sdk-default to pick up ECS task role credentials automatically
          credentialProvider: "aws-sdk-default"
        enableSniff: false
        enableHealthcheck: false
        logLevel: "error"
        indices:
          visibility: $TEMPORAL_ELASTICSEARCH_INDEX

global:
  membership:
    maxJoinDuration: 120s
    broadcastAddress: "$TEMPORAL_BROADCAST_ADDRESS"
  pprof:
    port: 7936
  metrics:
    prometheus:
      listenAddress: "0.0.0.0:9090"
      timerType: "histogram"

services:
  frontend:
    rpc:
      grpcPort: 7233
      membershipPort: 6933
      bindOnLocalHost: false
      bindOnIP: "$BIND_ON_IP"

  matching:
    rpc:
      grpcPort: 7235
      membershipPort: 6935
      bindOnLocalHost: false
      bindOnIP: "$BIND_ON_IP"

  history:
    rpc:
      grpcPort: 7234
      membershipPort: 6934
      bindOnLocalHost: false
      bindOnIP: "$BIND_ON_IP"

  worker:
    rpc:
      grpcPort: 7239
      membershipPort: 6939
      bindOnLocalHost: false
      bindOnIP: "$BIND_ON_IP"

clusterMetadata:
  enableGlobalNamespace: false
  failoverVersionIncrement: 10
  masterClusterName: "active"
  currentClusterName: "active"
  clusterInformation:
    active:
      enabled: true
      initialFailoverVersion: 1
      rpcAddress: "temporal-frontend:7233"

dcRedirectionPolicy:
  policy: "noop"

archival:
  history:
    state: "disabled"
  visibility:
    state: "disabled"

publicClient:
  hostPort: "temporal-frontend:7233"

dynamicConfigClient:
  filepath: "/etc/temporal/config/dynamicconfig/dynamicconfig.yaml"
  pollInterval: "10s"
